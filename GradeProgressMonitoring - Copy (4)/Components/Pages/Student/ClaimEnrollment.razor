@page "/student/claim"
@using System.ComponentModel.DataAnnotations
@using GradeProgressMonitoring.Data
@using GradeProgressMonitoring.Models
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@inject ApplicationDbContext Db
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<h1>Claim Your Enrollment</h1>

<p class="text-muted">
    Enter your Student Number, Last Name, and Section exactly as listed in your class roster.
    This links your login account to your enrollment so you can view your subjects and grades.
</p>

@if (!string.IsNullOrWhiteSpace(_error))
{
    <div class="alert alert-danger">@_error</div>
}
@if (!string.IsNullOrWhiteSpace(_success))
{
    <div class="alert alert-success">@_success</div>
}

<EditForm Model="_form" OnValidSubmit="LinkMyAccount" FormName="claimEnrollmentForm">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="row g-3" style="max-width: 980px;">
        <div class="col-md-4">
            <label class="form-label">Student No</label>
            <InputText class="form-control" @bind-Value="_form.StudentNo" />
            <ValidationMessage For="@(() => _form.StudentNo)" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Last Name</label>
            <InputText class="form-control" @bind-Value="_form.LastName" />
            <ValidationMessage For="@(() => _form.LastName)" />
        </div>

        <div class="col-md-4">
            <label class="form-label">Section</label>
            <InputText class="form-control" @bind-Value="_form.Section" />
            <ValidationMessage For="@(() => _form.Section)" />
        </div>

        <div class="col-12" style="margin-top: 10px;">
            <button type="submit" class="btn btn-primary">Link My Account</button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="Cancel">Cancel</button>
        </div>
    </div>
</EditForm>

@code {
    private string? _error;
    private string? _success;

    // ✅ REQUIRED for .NET 8/9/10 Blazor Web Apps (server form POST binding)
    [SupplyParameterFromForm]
    private ClaimForm _form { get; set; } = new();

    private sealed class ClaimForm
    {
        [Required]
        public string StudentNo { get; set; } = "";

        [Required]
        public string LastName { get; set; } = "";

        [Required]
        public string Section { get; set; } = "";
    }

    private async Task LinkMyAccount()
    {
        _error = null;
        _success = null;

        var studentNo = Normalize(_form.StudentNo);
        var lastNameInput = Normalize(_form.LastName);
        var section = Normalize(_form.Section);

        if (string.IsNullOrWhiteSpace(studentNo) ||
            string.IsNullOrWhiteSpace(lastNameInput) ||
            string.IsNullOrWhiteSpace(section))
        {
            _error = "Please fill out Student No, Last Name, and Section.";
            return;
        }

        // ✅ Get current logged-in user
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var principal = authState.User;

        var user = await UserManager.GetUserAsync(principal);
        if (user is null)
        {
            _error = "You must be logged in to claim enrollment.";
            return;
        }

        // ✅ Find matching roster entry
        // Your logs confirm StudentNo and Section exist on Enrollments.
        var enrollment = await Db.Enrollments
            .FirstOrDefaultAsync(e => e.StudentNo == studentNo && e.Section == section);

        if (enrollment is null)
        {
            _error = "No matching roster entry found. Please confirm your Student No and Section match the roster exactly.";
            return;
        }

        // ✅ Verify last name matches roster name like "CRUZ, LOLITA DE JESUS"
        var rosterName = Normalize(enrollment.StudentName);
        var rosterLastName = ExtractLastName(rosterName);

        // No StartsWith used here → warning eliminated
        if (!string.Equals(rosterLastName, lastNameInput, StringComparison.OrdinalIgnoreCase))
        {
            _error = "Last Name does not match the roster entry. Please enter your last name exactly as listed.";
            return;
        }

        // ✅ If already linked to another user, block
        if (!string.IsNullOrWhiteSpace(enrollment.StudentUserId))
        {
            if (string.Equals(enrollment.StudentUserId, user.Id, StringComparison.Ordinal))
            {
                _success = "Your enrollment is already linked to your account.";
                Nav.NavigateTo("/student/subjects", forceLoad: true);
                return;
            }

            _error = "This roster entry is already linked to another account. Please contact your instructor.";
            return;
        }

        // ✅ Link enrollment to this user (this is what My Subjects uses)
        enrollment.StudentUserId = user.Id;

        // OPTIONAL: keep StudentProfileId linkage too (your DB shows it exists)
        if (enrollment.StudentProfileId is null)
        {
            var profile = await Db.StudentProfiles.FirstOrDefaultAsync(p => p.StudentNo == studentNo);

            if (profile is null)
            {
                profile = new StudentProfile
                {
                    StudentNo = studentNo
                    // Don't set Email/LastName; your StudentProfile doesn't have them.
                    // If you have FullName, you can set it here.
                    // FullName = rosterName
                };

                Db.StudentProfiles.Add(profile);
                await Db.SaveChangesAsync();
            }

            enrollment.StudentProfileId = profile.StudentProfileId;

            // AspNetUsers table shows StudentProfileId exists (from your logs).
            if (user.StudentProfileId is null)
            {
                user.StudentProfileId = profile.StudentProfileId;
                await UserManager.UpdateAsync(user);
            }
        }

        await Db.SaveChangesAsync();

        _success = "Enrollment linked successfully!";
        Nav.NavigateTo("/student/subjects", forceLoad: true);
    }

    private void Cancel()
    {
        Nav.NavigateTo("/student/subjects");
    }

    // -------- Helpers --------

    private static string Normalize(string? s) => (s ?? "").Trim();

    private static string ExtractLastName(string rosterName)
    {
        if (string.IsNullOrWhiteSpace(rosterName))
            return "";

        var commaIndex = rosterName.IndexOf(',');
        var last = commaIndex >= 0 ? rosterName[..commaIndex] : rosterName;
        return last.Trim();
    }
}